<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculette Néphro Pro</title>
    <!-- Theme Color for PWA -->
    <meta name="theme-color" content="#38bdf8">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.378.0/dist/lucide.min.js"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f4f8; }
        .tab-button {
            transition: all 0.2s ease-in-out;
            color: #475569; /* slate-600 */
        }
        .tab-active { 
            background-color: #10b981; /* emerald-500 */
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .calculator-card { 
            transition: all 0.2s ease-in-out; 
            background-color: #ffffff;
        }
        .calculator-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
        }
        .unit-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
            padding-right: 0.5rem;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Main Container -->
    <div id="app-container" class="max-w-7xl mx-auto p-2 md:p-4">

        <!-- Header and Search -->
        <header class="bg-gradient-to-br from-sky-400 to-blue-500 text-white p-4 md:p-6 rounded-2xl shadow-lg mb-6 sticky top-2 z-20">
            <div class="flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="opacity-70 transform -scale-x-100"><path d="M15.41 21.06a10.94 10.94 0 0 1-8.5-4.46 10.13 10.13 0 0 1-2.52-7.39 9.83 9.83 0 0 1 3.55-7.23 10.33 10.33 0 0 1 8.8-3C20.69 1.48 24.52 6 22 10.55a8.73 8.73 0 0 1-5.34 4.79 10.45 10.45 0 0 1-1.25.32A10.38 10.38 0 0 1 15.41 21.06Z"></path></svg>
                <h1 class="text-2xl md:text-3xl font-extrabold text-center">Calculette Néphro</h1>
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="opacity-70"><path d="M15.41 21.06a10.94 10.94 0 0 1-8.5-4.46 10.13 10.13 0 0 1-2.52-7.39 9.83 9.83 0 0 1 3.55-7.23 10.33 10.33 0 0 1 8.8-3C20.69 1.48 24.52 6 22 10.55a8.73 8.73 0 0 1-5.34 4.79 10.45 10.45 0 0 1-1.25.32A10.38 10.38 0 0 1 15.41 21.06Z"></path></svg>
            </div>
             <p class="text-center text-sky-100 mt-1">L'outil essentiel pour la pratique clinique</p>
            <div class="mt-4 relative">
                <input type="text" id="searchInput" placeholder="Rechercher un calculateur..." class="w-full pl-10 pr-4 py-2.5 border-0 rounded-lg bg-white/20 text-white placeholder-sky-100 focus:ring-2 focus:ring-white/80 focus:bg-white/30 transition">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-sky-100 w-5 h-5"></i>
            </div>
        </header>

        <!-- Main Navigation Tabs -->
        <nav id="main-tabs" class="flex flex-wrap justify-center gap-2 mb-6 bg-slate-200/50 p-1.5 rounded-xl">
            <button data-tab="clinique" class="tab-button tab-active flex items-center gap-2 px-3 py-2 rounded-lg text-sm md:px-4 md:text-base"><i data-lucide="stethoscope" class="w-5 h-5"></i>Clinique</button>
            <button data-tab="dialyse" class="tab-button flex items-center gap-2 px-3 py-2 rounded-lg text-sm md:px-4 md:text-base"><i data-lucide="droplets" class="w-5 h-5"></i>Dialyse</button>
            <button data-tab="transplantation" class="tab-button flex items-center gap-2 px-3 py-2 rounded-lg text-sm md:px-4 md:text-base"><i data-lucide="heart-pulse" class="w-5 h-5"></i>Transplantation</button>
            <button data-tab="ia" class="tab-button flex items-center gap-2 px-3 py-2 rounded-lg text-sm md:px-4 md:text-base"><i data-lucide="brain-circuit" class="w-5 h-5"></i>IA</button>
            <button data-tab="historique" class="tab-button flex items-center gap-2 px-3 py-2 rounded-lg text-sm md:px-4 md:text-base"><i data-lucide="history" class="w-5 h-5"></i>Historique</button>
        </nav>

        <!-- Content Panes -->
        <main id="content-panes">
            <div id="clinique-pane" class="tab-pane grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6"></div>
            <div id="dialyse-pane" class="tab-pane hidden grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6"></div>
            <div id="transplantation-pane" class="tab-pane hidden grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6"></div>
            <div id="ia-pane" class="tab-pane hidden grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6"></div>
            <div id="historique-pane" class="tab-pane hidden space-y-4">
                 <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                    <p class="text-sm text-slate-600">Les 20 derniers calculs sont sauvegardés.</p>
                    <button id="clearHistoryBtn" class="text-sm font-semibold text-red-500 hover:text-red-700 flex items-center gap-1"><i data-lucide="trash-2" class="w-4 h-4"></i>Vider</button>
                </div>
                <div id="history-list" class="space-y-3"></div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-8 py-4">
            <p class="text-sm text-slate-500">Ibrahima Sow IDH Néphrologie</p>
            <p class="text-xs text-slate-400">Dernière mise à jour : 21 juin 2025</p>
        </footer>

    </div>

    <!-- Formula Modal -->
    <div id="formula-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-lg w-full transform transition-all scale-95 opacity-0" id="modal-inner">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-bold text-slate-800">Formule de Calcul</h3>
                <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="modal-content" class="text-sm text-slate-600 bg-slate-50 p-4 rounded-lg max-h-[70vh] overflow-y-auto"></div>
        </div>
    </div>


    <script>
    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker enregistré:', reg))
                .catch(err => console.log('Erreur Service Worker:', err));
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const appState = {
            values: { gender: 'male' },
            units: { creatinine: 'mg/dL', calcium: 'mg/dL', albumin: 'g/dL', urea: 'mg/dL', hb: 'g/dL', glucose: 'mg/dL', pth: 'pg/mL' },
            history: JSON.parse(localStorage.getItem('nephro_history_v41')) || [],
        };
        
        let creatinineChart = null;

        const calculators = [
            // === CLINIQUE ===
            {
                id: 'unit_converter',
                title: 'Convertisseur d\'Unités',
                tags: 'conversion, unités, convertisseur',
                pane: 'clinique',
                html: () => `<div class="space-y-4" id="converter-body"></div>`,
                calculate: () => ({}),
                postRender: function(card) {
                    const container = card.querySelector('#converter-body');
                    if (container.children.length > 0) return; 

                    const substances = [
                        { name: 'Urée', key: 'urea', units: ['mg/dL', 'mmol/L', 'g/L'] },
                        { name: 'Créatinine', key: 'creatinine', units: ['mg/dL', 'µmol/L', 'mg/L'] },
                        { name: 'Calcémie', key: 'calcium', units: ['mg/dL', 'mmol/L', 'mg/L'] },
                        { name: 'Glycémie', key: 'glucose', units: ['mg/dL', 'mmol/L', 'g/L'] },
                        { name: 'PTHi', key: 'pth', units: ['pg/mL', 'pmol/L'] },
                    ];

                    const createConverterRow = (sub) => {
                        return `
                            <div class="space-y-2">
                                <label class="font-semibold text-slate-600">${sub.name}</label>
                                <div class="grid grid-cols-1 sm:grid-cols-[1fr_auto_1fr] items-center gap-2">
                                    <div class="flex gap-2">
                                        <input type="number" data-converter-input="${sub.key}" data-converter-idx="1" class="w-full p-2 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-emerald-500">
                                        <select data-converter-select="${sub.key}" data-converter-idx="1" class="unit-select p-2 border border-slate-300 rounded-lg bg-slate-50 font-semibold">
                                            ${sub.units.map(u => `<option value="${u}">${u}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="text-center font-bold text-slate-500">=</div>
                                    <div class="flex gap-2">
                                        <input type="number" data-converter-input="${sub.key}" data-converter-idx="2" class="w-full p-2 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-emerald-500">
                                        <select data-converter-select="${sub.key}" data-converter-idx="2" class="unit-select p-2 border border-slate-300 rounded-lg bg-slate-50 font-semibold">
                                            ${sub.units.map((u, i) => `<option value="${u}" ${i === 1 ? 'selected' : ''}>${u}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        `;
                    };
                    
                    container.innerHTML = substances.map(createConverterRow).join('');
                }
            },
            {
                id: 'dfg_clearance',
                title: 'DFG (CKD-EPI 2021)',
                tags: 'dfg clairance créatinine ckd-epi',
                pane: 'clinique',
                html: () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputField('age', 'Âge', 'number', 'ans')}${inputField('creat', 'Créatinine', 'number')}${genderDropdown()}</div>${resultDisplay(['dfg'])}<div class="mt-4">${actionButtons('dfg_clearance')}</div>`,
                formula: `<p><b>CKD-EPI 2021 (Créatinine):</b><br>142 x min(SCr/κ, 1)<sup>α</sup> x max(SCr/κ, 1)<sup>-1.200</sup> x 0.9938<sup>Âge</sup> x (1.012 si Femme)</p><p class='text-xs italic mt-2'>Réf: Inker LA, et al. N Engl J Med. 2021.</p>`,
                calculate: function() {
                    const { age, creat, gender } = appState.values;
                    if (!age || !creat) return { dfg: 'N/A' };
                    let creat_mgdl = convertUnit('creatinine', creat, appState.units.creatinine, 'mg/dL');
                    if (isNaN(creat_mgdl)) return { dfg: 'N/A' };
                    const k = gender === 'female' ? 0.7 : 0.9;
                    const a = gender === 'female' ? -0.241 : -0.302;
                    const gfr = 142 * Math.pow(Math.min(creat_mgdl / k, 1), a) * Math.pow(Math.max(creat_mgdl / k, 1), -1.200) * Math.pow(0.9938, age) * (gender === 'female' ? 1.012 : 1);
                    return { dfg: `<span class="font-bold text-3xl text-emerald-600">${Math.round(gfr)}</span> mL/min/1.73m²` };
                }
            },
            {
                id: 'kdigo_aki',
                title: 'Définition IRA (KDIGO)',
                tags: 'kdigo, ira, insuffisance renale aigue, creatinine, diurese',
                pane: 'clinique',
                html: () => `
                    <div>
                        <div class="mb-4">
                            <h4 class="font-semibold mb-2 text-slate-600">Critères sur la Créatininémie</h4>
                             <div class="flex items-center gap-2 mb-2">
                                <label for="kdigo_creat_unit" class="text-sm font-medium">Unité Créat.</label>
                                ${unitDropdown('creatinine', ['mg/dL', 'µmol/L', 'mg/L'])}
                            </div>
                            <div id="kdigo-creat-entries" class="space-y-2">
                                <!-- Dynamic entries here -->
                            </div>
                            <button id="add-kdigo-creat-entry" class="text-sm font-semibold text-emerald-600 flex items-center gap-1 mt-2"><i data-lucide="plus-circle" class="w-4 h-4"></i>Ajouter une mesure</button>
                        </div>
                        <div class="mb-4 border-t pt-4">
                             <h4 class="font-semibold mb-2 text-slate-600">Critère sur la Diurèse</h4>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${inputField('urine_vol_kdigo', 'Volume Urinaire', 'number', 'mL')}
                                ${inputField('urine_hours_kdigo', 'Durée du recueil', 'number', 'heures')}
                                ${inputField('weight', 'Poids du patient', 'number', 'kg')}
                             </div>
                        </div>
                         ${resultDisplay(['kdigo_result'])}
                         <div class="mt-4">${actionButtons('kdigo_aki')}</div>
                    </div>
                `,
                formula: `<b>Critères KDIGO pour l'IRA:</b><br>
                <ul class="list-disc ml-5 mt-2 text-xs">
                    <li>↑ Créatinine ≥ 0.3 mg/dL (26.5 µmol/L) en 48h</li>
                    <li>↑ Créatinine ≥ 1.5x la valeur de base (connue ou présumée dans les 7 jours)</li>
                    <li>Diurèse < 0.5 mL/kg/h pendant 6 heures</li>
                </ul>`,
                calculate: function() { /* Logic handled in specific button click */ return { kdigo_result: '' }; },
                postRender: function(card) {
                    renderKdigoCreatinineEntries(card);
                }
            },
            {
                id: 'urea_creat_ratio',
                title: 'Rapport Urée / Créatinine',
                tags: 'urée, créatinine, rapport, ira, fonctionnelle, organique, bun',
                pane: 'clinique',
                html: () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputField('urea_p', 'Urée Plasmatique', 'number')}${inputField('creat', 'Créatinine Plasmatique', 'number')}</div><p class="text-xs text-center text-slate-500 mt-2">Le calcul utilise l'urée en mmol/L et la créatinine en µmol/L.</p>${resultDisplay(['ratio_result', 'ratio_interpretation'])}<div class="mt-4">${actionButtons('urea_creat_ratio')}</div>`,
                formula: `<b>Rapport = (Urée en mmol/L × 1000) / Créatinine en µmol/L</b>`,
                calculate: function() {
                    const { urea_p, creat } = appState.values;
                    if (!urea_p || !creat) return { ratio_result: 'N/A', ratio_interpretation: '' };
                    const urea_mmol = convertUnit('urea', urea_p, appState.units.urea, 'mmol/L');
                    const creat_umol = convertUnit('creatinine', creat, appState.units.creatinine, 'µmol/L');
                    if (isNaN(urea_mmol) || isNaN(creat_umol)) return { ratio_result: 'N/A', ratio_interpretation: '' };
                    const ratio = 1000 * urea_mmol / creat_umol;
                    let interpretation, color;
                    if (ratio > 100) { interpretation = "IRA d'allure fonctionnelle"; color = 'text-orange-600'; } 
                    else if (ratio < 50) { interpretation = "IRA d'allure organique"; color = 'text-red-600'; } 
                    else { interpretation = 'Zone grise / non-spécifique'; color = 'text-slate-600'; }
                    return { ratio_result: `<span class="font-bold text-3xl text-emerald-600">${ratio.toFixed(1)}</span>`, ratio_interpretation: `<span class="font-semibold ${color}">${interpretation}</span>` };
                }
            },
             {
                id: 'feu',
                title: 'Fraction d\'Excrétion de l\'Urée (FeU)',
                tags: 'feu urée fraction excrétion urinaire',
                pane: 'clinique',
                html: () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputField('urea_p', 'Urée Plasmatique', 'number')}${inputField('urea_u', 'Urée Urinaire', 'number')}${inputField('creat', 'Créatinine Plasmatique', 'number')}${inputField('u_creat', 'Créatinine Urinaire', 'number')}</div><p class="text-xs text-center text-slate-500 mt-2">Les unités Urée/Créat. doivent être les mêmes que les plasmatiques.</p>${resultDisplay(['feu_result'])}<div class="mt-4">${actionButtons('feu')}</div>`,
                formula: `<b>FeU (%) = [(Urée Urinaire x Créat Plasmatique) / (Urée Plasmatique x Créat Urinaire)] x 100</b>`,
                calculate: function() {
                    const { urea_p, urea_u, creat, u_creat } = appState.values;
                    if (!urea_p || !urea_u || !creat || !u_creat) return { feu_result: 'N/A' };
                    const urea_p_base = convertUnit('urea', urea_p, appState.units.urea, 'mg/dL');
                    const urea_u_base = convertUnit('urea', urea_u, appState.units.urea, 'mg/dL');
                    const creat_p_base = convertUnit('creatinine', creat, appState.units.creatinine, 'mg/dL');
                    const creat_u_base = convertUnit('creatinine', u_creat, appState.units.creatinine, 'mg/dL');
                    
                    if (isNaN(urea_p_base) || isNaN(urea_u_base) || isNaN(creat_p_base) || isNaN(creat_u_base) || urea_p_base === 0 || creat_u_base === 0) return { feu_result: 'N/A' };

                    const feu = ((urea_u_base * creat_p_base) / (urea_p_base * creat_u_base)) * 100;
                    return { feu_result: `<span class="font-bold text-3xl text-emerald-600">${feu.toFixed(1)} %</span>` };
                }
            },
            {
                id: 'osm_plasmique',
                title: 'Osmolarité Plasmatique Calculée',
                tags: 'osmolarité, plasma, trou osmolaire',
                pane: 'clinique',
                html: () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputField('na', 'Sodium', 'number', 'mmol/L')}${inputField('k', 'Potassium', 'number', 'mmol/L')}${inputField('glucose', 'Glycémie', 'number')}${inputField('urea_p', 'Urée', 'number')}</div>${resultDisplay(['osm_p_result'])}<div class="mt-4">${actionButtons('osm_plasmique')}</div>`,
                formula: '<b>Osmolarité Plasmatique (mOsm/kg) = 2 x (Na⁺ + K⁺) + Glucose + Urée</b><br><p class="text-xs italic mt-1">Toutes les valeurs doivent être en mmol/L.</p>',
                calculate: function() {
                    const { na, k, glucose, urea_p } = appState.values;
                    if (!na || !k || !glucose || !urea_p) return { osm_p_result: 'N/A' };
                    const glucose_mmol = convertUnit('glucose', glucose, appState.units.glucose, 'mmol/L');
                    const urea_mmol = convertUnit('urea', urea_p, appState.units.urea, 'mmol/L');
                    const osm = 2 * (parseFloat(na) + parseFloat(k)) + glucose_mmol + urea_mmol;
                    return { osm_p_result: `<span class="font-bold text-3xl text-emerald-600">${osm.toFixed(1)}</span> mOsm/kg H₂O`};
                }
            },
            {
                id: 'osm_urinaire_calc',
                title: 'Osmolarité Urinaire Calculée',
                tags: 'osmolarité, urinaire, calculée, urine',
                pane: 'clinique',
                html: () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputField('u_na', 'Sodium Urinaire', 'number', 'mmol/L')}${inputField('u_k', 'Potassium Urinaire', 'number', 'mmol/L')}${inputField('urea_u', 'Urée Urinaire', 'number')}</div>${resultDisplay(['osm_u_calc_result'])}<div class="mt-4">${actionButtons('osm_urinaire_calc')}</div>`,
                formula: '<b>Osmolarité Urinaire (mOsm/kg) = 2 x (Na⁺ᵤ + K⁺ᵤ) + Uréeᵤ</b><br><p class="text-xs italic mt-1">Toutes les valeurs doivent être en mmol/L.</p>',
                calculate: function() {
                    const { u_na, u_k, urea_u } = appState.values;
                    if (!u_na || !u_k || !urea_u) return { osm_u_calc_result: 'N/A' };
                    const urea_u_mmol = convertUnit('urea', urea_u, appState.units.urea, 'mmol/L');
                    const osm = 2 * (parseFloat(u_na) + parseFloat(u_k)) + urea_u_mmol;
                    return { osm_u_calc_result: `<span class="font-bold text-3xl text-emerald-600">${osm.toFixed(1)}</span> mOsm/kg H₂O`};
                }
            },
            {
                id: 'osm_urinaire_est',
                title: 'Osmolarité Urinaire Estimée',
                tags: 'osmolarité, urinaire, estimée, densité, urine',
                pane: 'clinique',
                html: () => `<div class="grid grid-cols-1">${inputField('density_u', 'Densité Urinaire', 'number','', 1.010)}</div>${resultDisplay(['osm_u_est_result'])}<div class="mt-4">${actionButtons('osm_urinaire_est')}</div>`,
                formula: '<b>Osmolarité Urinaire (mOsm/kg) ≈ (Densité Urinaire - 1000) * 35</b><br><p class="text-xs italic mt-1">La densité est exprimée en g/L (ex: 1.010 devient 1010).</p>',
                calculate: function() {
                    const { density_u } = appState.values;
                    if (!density_u) return { osm_u_est_result: 'N/A' };
                    const density = parseFloat(density_u) * 1000;
                    const osm = (density - 1000) * 35;
                    return { osm_u_est_result: `<span class="font-bold text-3xl text-emerald-600">${osm.toFixed(0)}</span> mOsm/kg H₂O`};
                }
            },
            {
                id: 'fena',
                title: 'Fraction d\'Excrétion du Sodium (FeNa)',
                tags: 'fena sodium fraction excrétion urinaire insuffisance rénale aigue ira',
                pane: 'clinique',
                html: () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputField('na', 'Natrémie (P)', 'number', 'mmol/L')}${inputField('u_na', 'Sodium (U)', 'number', 'mmol/L')}${inputField('creat', 'Créatinine (P)', 'number')}${inputField('u_creat', 'Créatinine (U)', 'number')}</div><p class="text-xs text-center text-slate-500 mt-2">Unité Créat. Urinaire = Créat. Plasmatique (${appState.units.creatinine}).</p>${resultDisplay(['fena_result', 'fena_interpretation'])}<div class="mt-4">${actionButtons('fena')}</div><div class="text-xs text-center text-amber-700 bg-amber-50 p-2 rounded-lg mt-3"><b>Note:</b> Moins fiable chez les patients sous diurétiques.</div>`,
                formula: 'FeNa (%) = [(Na Urinaire x Créat Plasmatique) / (Na Plasmatique x Créat Urinaire)] x 100',
                calculate: function() {
                    const { na, u_na, creat, u_creat } = appState.values;
                    if (!na || !u_na || !creat || !u_creat) { return { fena_result: 'N/A', fena_interpretation: '' }; }
                    const creat_mgdl = convertUnit('creatinine', creat, appState.units.creatinine, 'mg/dL');
                    const u_creat_mgdl = convertUnit('creatinine', u_creat, appState.units.creatinine, 'mg/dL');
                    const fena = ((u_na * creat_mgdl) / (na * u_creat_mgdl)) * 100;
                    let interpretation, color;
                    if (fena < 1) { interpretation = 'Suggère une cause pré-rénale.'; color = 'text-green-700'; }
                    else if (fena > 2) { interpretation = 'Suggère une nécrose tubulaire aiguë.'; color = 'text-red-700'; }
                    else { interpretation = 'Résultat non-spécifique.'; color = 'text-amber-700'; }
                    return { fena_result: `<span class="font-bold text-3xl">${fena.toFixed(2)} %</span>`, fena_interpretation: `<span class="font-semibold ${color}">${interpretation}</span>`};
                }
            },
            {
                id: 'sodium_deficit',
                title: 'Déficit en Sodium (Hyponatrémie)',
                tags: 'sodium deficit hyponatrémie watson ect',
                pane: 'clinique',
                html: () => `<div class="text-sm text-center bg-emerald-50 text-emerald-700 p-2 rounded-lg mb-4">Calcul pour hyponatrémie hypovolémique. L'Eau Corporelle Totale (ECT) est estimée par la formule de Watson.</div><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputField('weight', 'Poids', 'number', 'kg')}${inputField('height', 'Taille', 'number', 'cm')}${inputField('age', 'Âge', 'number', 'ans')}${genderDropdown()}${inputField('na', 'Natrémie actuelle', 'number', 'mmol/L')}${inputField('target_na', 'Natrémie cible', 'number', 'mmol/L', 135)}</div>${resultDisplay(['na_deficit_mmol', 'na_deficit_g', 'nacl_deficit_g'])}<div class="mt-4">${actionButtons('sodium_deficit')}</div>`,
                formula: '<b>ECT (Watson) Homme:</b> 2.447 - (0.09156 x Âge) + (0.1074 x Taille cm) + (0.3362 x Poids kg)<br><b>ECT (Watson) Femme:</b> -2.097 + (0.1069 * height) + (0.2466 * weight)<br><b>Déficit (mmol):</b> (Natrémie Cible - Natrémie Actuelle) x ECT',
                calculate: function() {
                    const { weight, height, age, na, target_na, gender } = appState.values;
                    if (!weight || !height || !age || !na || !target_na) return { na_deficit_mmol: 'N/A' };
                    let ect;
                    if (gender === 'male') { ect = 2.447 - (0.09156 * age) + (0.1074 * height) + (0.3362 * weight); } 
                    else { ect = -2.097 + (0.1069 * height) + (0.2466 * weight); }
                    const na_deficit = (target_na - na) * ect;
                    if(na_deficit <= 0) return { na_deficit_mmol: 'Aucun déficit', na_deficit_g: '', nacl_deficit_g: '' };
                    return { na_deficit_mmol: `<span class="text-3xl font-bold text-emerald-600">${na_deficit.toFixed(0)}</span> mmol de Na`, na_deficit_g: `<span class="text-xl font-semibold">${(na_deficit * 0.023).toFixed(1)}</span> g de Sodium (Na)`, nacl_deficit_g: `<span class="text-xl font-semibold">${(na_deficit * 0.0585).toFixed(1)}</span> g de Chlorure de Sodium (NaCl)` };
                }
            },
            {
                id: 'corrected_calcium',
                title: 'Calcémie Corrigée',
                tags: 'calcium albumine protides calcémie corrigée albert isbell payne',
                pane: 'clinique',
                html: () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputField('ca', 'Calcémie mesurée', 'number')}${inputField('alb', 'Albumine', 'number')}${inputField('prot', 'Protides totaux', 'number', 'g/L')}</div>${resultDisplay(['corrected_ca_standard', 'corrected_ca_old_revised', 'corrected_ca_new_revised'])}<div class="mt-4">${actionButtons('corrected_calcium')}</div>`,
                formula: `<div class='space-y-4'><div><b class='text-slate-700'>1. Formule Standard (Payne):</b><br>Ca Corrigée (mmol/L) = Ca Mesurée (mmol/L) + ((40 - Albumine g/L) * 0.02)</div><div><b class='text-slate-700'>2. Ancienne Formule Révisée (avec Protides):</b><br>Ca Corrigée (mg/dL) = Ca(mes) + 0.49 * (4.4 - Alb) + 0.19 * (8.0 - Protides)<p class='text-xs mt-1 text-slate-500'>Unités: Ca(mes) en mg/dL, Alb en g/dL, Protides en g/dL.</p></div><div><b class='text-slate-700'>3. Nouvelle Formule Révisée (Albert-Isbell, 2023):</b><br>Ca(rév) = Ca(mes) + [(4 - Alb) * (Ca(mes) * 0.052)]<p class='text-xs mt-1 text-slate-500'>Unités: Ca(mes) en mg/dL, Alb en g/dL.</p><p class='text-xs italic text-slate-500'>Réf: Albert SG, Isbell TS. Clinica Chimica Acta. 2023.</p></div></div>`,
                calculate: function() {
                    const { ca, alb, prot } = appState.values;
                    const selectedUnit = appState.units.calcium;
                    if (!ca || !alb) { return { corrected_ca_standard: `Standard: <span class="font-bold">N/A</span>`, corrected_ca_old_revised: `Anc. Révisée: <span class="font-bold">N/A</span>`, corrected_ca_new_revised: `Nouv. Révisée: <span class="font-bold text-emerald-600">N/A</span>` }; }
                    const ca_mmol_input = convertUnit('calcium', ca, selectedUnit, 'mmol/L');
                    const ca_mgdl_input = convertUnit('calcium', ca, selectedUnit, 'mg/dL');
                    const alb_gl_input = convertUnit('albumin', alb, appState.units.albumin, 'g/L');
                    const alb_gdl_input = convertUnit('albumin', alb, appState.units.albumin, 'g/dL');
                    const standard_result_mmol = ca_mmol_input + ((40 - alb_gl_input) * 0.02);
                    const final_standard_result = convertUnit('calcium', standard_result_mmol, 'mmol/L', selectedUnit);
                    const standard_display = `${final_standard_result.toFixed(2)} <span class="text-base">${selectedUnit}</span>`;
                    let old_revised_display = 'N/A (Protides manquants)';
                    if (prot) {
                        const prot_gdl_input = prot / 10;
                        const old_revised_result_mgdl = ca_mgdl_input + 0.49 * (4.4 - alb_gdl_input) + 0.19 * (8.0 - prot_gdl_input);
                        const final_old_revised_result = convertUnit('calcium', old_revised_result_mgdl, 'mg/dL', selectedUnit);
                        old_revised_display = `${final_old_revised_result.toFixed(2)} <span class="text-base">${selectedUnit}</span>`;
                    }
                    const new_revised_result_mgdl = ca_mgdl_input + ((4 - alb_gdl_input) * (ca_mgdl_input * 0.052));
                    const final_new_revised_result = convertUnit('calcium', new_revised_result_mgdl, 'mg/dL', selectedUnit);
                    const new_revised_display = `${final_new_revised_result.toFixed(2)} <span class="text-base">${selectedUnit}</span>`;
                    return { corrected_ca_standard: `Standard: <span class="font-bold">${standard_display}</span>`, corrected_ca_old_revised: `Anc. Révisée: <span class="font-bold">${old_revised_display}</span>`, corrected_ca_new_revised: `Nouv. Révisée: <span class="font-bold text-emerald-600">${new_revised_display}</span>` };
                }
            },
             {
                id: 'iron_deficit',
                title: 'Déficit en Fer (Ganzoni)',
                tags: 'fer, anémie, carence, ganzoni, dialyse, mrc, anemie',
                pane: 'clinique',
                html: () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputField('weight', 'Poids', 'number', 'kg')}${inputField('actual_hb', 'Hémoglobine Actuelle', 'number')}${inputField('target_hb', 'Hémoglobine Cible', 'number', '', 11)}</div>${resultDisplay(['iron_deficit_result'])}<div class="mt-4">${actionButtons('iron_deficit')}</div><p class="text-xs text-slate-400 text-center mt-2">Valable pour les patients dialysés et non-dialysés.</p>`,
                formula: `<b>Déficit en Fer (mg) = Poids (kg) x (Hb Cible - Hb Actuelle) [g/dL] x 2.4 + Réserves en Fer</b><br><br><p class='text-xs italic'>Les réserves en fer sont estimées à 500 mg pour un poids > 35 kg.</p>`,
                calculate: function() {
                    const { weight, actual_hb, target_hb } = appState.values;
                    const hbUnit = appState.units.hb;
                    if(!weight || !actual_hb || !target_hb) return { iron_deficit_result: 'N/A'};
                    const actual_hb_gdl = convertUnit('hb', actual_hb, hbUnit, 'g/dL');
                    const target_hb_gdl = convertUnit('hb', target_hb, hbUnit, 'g/dL');
                    const hb_diff = target_hb_gdl - actual_hb_gdl;
                    if(hb_diff <= 0) return { iron_deficit_result: 'Aucun déficit calculé.'};
                    const iron_stores = weight > 35 ? 500 : 15 * weight;
                    const deficit = weight * hb_diff * 2.4 + iron_stores;
                    return { iron_deficit_result: `<span class="font-bold text-3xl text-emerald-600">${Math.round(deficit)}</span> mg` };
                }
            },
            {
                id: 'cv_risk',
                title: 'Risque Cardiovasculaire (Framingham)',
                tags: 'risque, cardiovasculaire, framingham, score, mrc',
                pane: 'clinique',
                html: () => `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${genderDropdown()}
                        ${inputField('age', 'Âge', 'number', 'ans')}
                        ${inputField('total_chol', 'Cholestérol Total', 'number', 'mg/dL')}
                        ${inputField('hdl_chol', 'HDL Cholestérol', 'number', 'mg/dL')}
                        ${inputField('sbp', 'Pression Artérielle Systolique', 'number', 'mmHg')}
                        <div class="space-y-1.5"><label class="text-sm font-medium text-slate-600">Fumeur</label><div class="flex rounded-lg border border-slate-300 overflow-hidden"><input type="radio" name="smoker" id="smoker_yes" value="1" class="sr-only peer/yes"><label for="smoker_yes" class="w-1/2 text-center p-2 cursor-pointer peer-checked/yes:bg-emerald-500 peer-checked/yes:text-white transition">Oui</label><input type="radio" name="smoker" id="smoker_no" value="0" class="sr-only peer/no" checked><label for="smoker_no" class="w-1/2 text-center p-2 cursor-pointer peer-checked/no:bg-emerald-500 peer-checked/no:text-white transition border-l">Non</label></div></div>
                        <div class="space-y-1.5"><label class="text-sm font-medium text-slate-600">Traité pour HTA</label><div class="flex rounded-lg border border-slate-300 overflow-hidden"><input type="radio" name="htn_treated" id="htn_yes" value="1" class="sr-only peer/yes_htn"><label for="htn_yes" class="w-1/2 text-center p-2 cursor-pointer peer-checked/yes_htn:bg-emerald-500 peer-checked/yes_htn:text-white transition">Oui</label><input type="radio" name="htn_treated" id="htn_no" value="0" class="sr-only peer/no_htn" checked><label for="htn_no" class="w-1/2 text-center p-2 cursor-pointer peer-checked/no_htn:bg-emerald-500 peer-checked/no_htn:text-white transition border-l">Non</label></div></div>
                    </div>
                    ${resultDisplay(['cv_risk_result'])}
                    <div class="mt-4">${actionButtons('cv_risk')}</div>
                `,
                formula: 'Score de risque de maladie cardiovasculaire à 10 ans basé sur la formule de Framingham (2008).',
                calculate: function() {
                    const { age, total_chol, hdl_chol, sbp, gender } = appState.values;
                    const smoker = parseInt(this.querySelector('input[name="smoker"]:checked')?.value || '0');
                    const htn_treated = parseInt(this.querySelector('input[name="htn_treated"]:checked')?.value || '0');

                    if(!age || !total_chol || !hdl_chol || !sbp) return {cv_risk_result: 'N/A'};
                    
                    let l, s0;
                    if(gender === 'male'){
                        l = 2.32888 * Math.log(age) + 1.20904 * Math.log(total_chol) - 0.70833 * Math.log(hdl_chol) + (htn_treated ? 2.82263 : 2.76157) * Math.log(sbp) + 0.52873 * smoker;
                        s0 = 0.9602;
                    } else { // female
                        l = 2.65921 * Math.log(age) + 1.31341 * Math.log(total_chol) - 0.90332 * Math.log(hdl_chol) + (htn_treated ? 2.88267 : 2.81291) * Math.log(sbp) + 0.61868 * smoker;
                        s0 = 0.9870;
                    }
                    const mean_l = (gender === 'male') ? 23.9802 : 26.1931;
                    const risk = (1 - Math.pow(s0, Math.exp(l - mean_l))) * 100;
                    
                    let riskColor = 'text-green-600';
                    if (risk >= 10) riskColor = 'text-yellow-600';
                    if (risk >= 20) riskColor = 'text-red-600';

                    return { cv_risk_result: `Risque à 10 ans : <span class="font-bold text-3xl ${riskColor}">${risk.toFixed(1)}%</span>`};
                }
            },
            // === DIALYSE ===
            {
                id: 'rrf',
                title: 'Fonction Rénale Résiduelle (HD & DP)',
                tags: 'frr rrf fonction rénale résiduelle dialyse hémodialyse péritonéale clairance urée',
                pane: 'dialyse',
                html: () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputField('urea_p', 'Urée Plasmatique', 'number')}${inputField('urea_u', 'Urée Urinaire', 'number')}${inputField('creat', 'Créatinine Plasmatique', 'number')}${inputField('u_creat', 'Créatinine Urinaire', 'number')}<div class="md:col-span-2">${inputField('urine_vol_24h', 'Volume Urinaire / 24h', 'number', 'mL')}</div></div><p class="text-xs text-center text-slate-500 mt-2">Les unités Urée/Créat. urinaires doivent être les mêmes que les plasmatiques.</p>${resultDisplay(['rrf_result', 'rrf_interpretation'])}<div class="mt-4">${actionButtons('rrf')}</div>`,
                formula: `La FRR est la moyenne des clairances de l'urée et de la créatinine.<br><br><b>Clairance (mL/min) = [Concentration Urinaire x Volume Urinaire (mL)] / [Concentration Plasmatique x 1440 (min)]</b><br><br><b>FRR = (Clairance Urée + Clairance Créatinine) / 2</b>`,
                calculate: function() {
                    const { urea_p, urea_u, creat, u_creat, urine_vol_24h } = appState.values;
                    if (!urea_p || !urea_u || !creat || !u_creat || !urine_vol_24h) return { rrf_result: 'N/A', rrf_interpretation: '' };
                    const urea_p_base = convertUnit('urea', urea_p, appState.units.urea, 'mg/dL');
                    const urea_u_base = convertUnit('urea', urea_u, appState.units.urea, 'mg/dL');
                    const creat_p_base = convertUnit('creatinine', creat, appState.units.creatinine, 'mg/dL');
                    const creat_u_base = convertUnit('creatinine', u_creat, appState.units.creatinine, 'mg/dL');
                    const urea_clearance = (urea_u_base * urine_vol_24h) / (urea_p_base * 1440);
                    const creat_clearance = (creat_u_base * urine_vol_24h) / (creat_p_base * 1440);
                    const rrf = (urea_clearance + creat_clearance) / 2;
                    let interpretation = '';
                    if (urine_vol_24h < 100) { interpretation = `<span class="font-semibold text-red-600">Diurèse < 100 mL/24h (anurie). FRR perdue.</span>`; } 
                    else if (rrf >= 2) { interpretation = `<span class="font-semibold text-green-600">FRR conservée (> 2 mL/min). Associée à une meilleure survie.</span>`; } 
                    else { interpretation = `<span class="font-semibold text-orange-600">FRR significativement altérée (< 2 mL/min).</span>`; }
                    return { rrf_result: `<span class="font-bold text-3xl text-emerald-600">${rrf.toFixed(2)}</span> mL/min`, rrf_interpretation: interpretation };
                }
            },
            {
                id: 'ktv',
                title: 'Kt/V (Daugirdas 2)',
                tags: 'kt/v daugirdas dialyse urée',
                pane: 'dialyse',
                html: () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputField('urea_p', 'Urée pré-dialyse', 'number')}${inputField('post_urea', 'Urée post-dialyse', 'number')}${inputField('duration', 'Durée dialyse', 'number', 'heures')}${inputField('uf_volume', 'Volume ultrafiltration', 'number', 'L')}${inputField('post_weight', 'Poids post-dialyse', 'number', 'kg')}</div>${resultDisplay(['ktv_result'])}<div class="mt-4">${actionButtons('ktv')}</div>`,
                formula: 'Kt/V = -ln((Urée Post / Urée Pré) - 0.008 * t) + (4 - 3.5 * (Urée Post / Urée Pré)) * UF / Poids Post',
                calculate: function() {
                    const { urea_p, post_urea, duration, uf_volume, post_weight } = appState.values;
                    if (!urea_p || !post_urea || !duration || !uf_volume || !post_weight) return { ktv_result: 'N/A' };
                    const urea_pre_base = convertUnit('urea', urea_p, appState.units.urea, 'mg/dL');
                    const urea_post_base = convertUnit('urea', post_urea, appState.units.urea, 'mg/dL');
                    const r = urea_post_base / urea_pre_base;
                    const ktv = -Math.log(r - 0.008 * duration) + (4 - 3.5 * r) * uf_volume / post_weight;
                    return { ktv_result: `<span class="font-bold text-3xl">${ktv.toFixed(2)}</span>` };
                }
            },
            {
                id: 'urr',
                title: 'Taux de Réduction de l\'Urée (URR)',
                tags: 'urr dialyse urée',
                pane: 'dialyse',
                html: () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputField('urea_p', 'Urée pré-dialyse', 'number')}${inputField('post_urea', 'Urée post-dialyse', 'number')}</div>${resultDisplay(['urr_result'])}<div class="mt-4">${actionButtons('urr')}</div>`,
                formula: 'URR (%) = ((Urée Pré - Urée Post) / Urée Pré) x 100',
                calculate: function() {
                    const { urea_p, post_urea } = appState.values;
                    if (!urea_p || !post_urea) return { urr_result: 'N/A' };
                    const urea_pre_base = convertUnit('urea', urea_p, appState.units.urea, 'mg/dL');
                    const urea_post_base = convertUnit('urea', post_urea, appState.units.urea, 'mg/dL');
                    const urr = ((urea_pre_base - urea_post_base) / urea_pre_base) * 100;
                    return { urr_result: `<span class="font-bold text-3xl">${urr.toFixed(1)}</span> %` };
                }
            },
            // === TRANSPLANTATION ===
            {
                id: 'graft_loss_risk',
                title: 'Risque de Perte du Greffon',
                tags: 'transplantation greffon rein risque perte',
                pane: 'transplantation',
                html: () => `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${inputField('age', 'Âge', 'number', 'ans')}${inputField('creat', 'Créatinine', 'number')}${genderDropdown()}<div class="space-y-1.5"><label class="text-sm font-medium text-slate-600">Donneur décédé</label><div class="flex rounded-lg border border-slate-300 overflow-hidden"><input type="radio" name="donor_type" id="donor_yes" value="yes" class="sr-only peer/yes"><label for="donor_yes" class="w-1/2 text-center p-2 cursor-pointer peer-checked/yes:bg-emerald-500 peer-checked/yes:text-white transition">Oui</label><input type="radio" name="donor_type" id="donor_no" value="no" class="sr-only peer/no" checked><label for="donor_no" class="w-1/2 text-center p-2 cursor-pointer peer-checked/no:bg-emerald-500 peer-checked/no:text-white transition border-l border-slate-300">Non</label></div></div><div class="space-y-1.5"><label class="text-sm font-medium text-slate-600">Re-transplantation</label><div class="flex rounded-lg border border-slate-300 overflow-hidden"><input type="radio" name="retransplant" id="retransplant_yes" value="yes" class="sr-only peer/re_yes"><label for="retransplant_yes" class="w-1/2 text-center p-2 cursor-pointer peer-checked/re_yes:bg-emerald-500 peer-checked/re_yes:text-white transition">Oui</label><input type="radio" name="retransplant" id="retransplant_no" value="no" class="sr-only peer/re_no" checked><label for="retransplant_no" class="w-1/2 text-center p-2 cursor-pointer peer-checked/re_no:bg-emerald-500 peer-checked/re_no:text-white transition border-l border-slate-300">Non</label></div></div></div>${resultDisplay(['graft_risk'])}<div class="mt-4">${actionButtons('graft_loss_risk')}</div><p class="text-xs text-slate-400 text-center mt-2">Basé sur le modèle de Foucher et al.</p>`,
                formula: 'Score de risque de perte du greffon à 5 ans, basé sur le modèle de Foucher et al. (2010). Le score est calculé à partir de l\'âge du receveur, du DFG (estimé par MDRD), du type de donneur et de la re-transplantation.',
                calculate: function() {
                    const { age, creat, gender } = appState.values;
                    if (!age || !creat) return { graft_risk: 'N/A' };
                    const isDeceasedDonor = this.querySelector('input[name="donor_type"]:checked')?.value === 'yes';
                    const isRetransplant = this.querySelector('input[name="retransplant"]:checked')?.value === 'yes';
                    const creat_mgdl = convertUnit('creatinine', creat, appState.units.creatinine, 'mg/dL');
                    const mdrd = 175 * Math.pow(creat_mgdl, -1.154) * Math.pow(age, -0.203) * (gender === 'female' ? 0.742 : 1);
                    let score = 0.02 * age - 0.03 * mdrd + (isDeceasedDonor ? 0.53 : 0) + (isRetransplant ? 0.49 : 0);
                    const risk = 1 / (1 + Math.exp(-(-2.27 + score))) * 100;
                    return { graft_risk: `Risque à 5 ans : <span class="font-bold text-3xl text-emerald-600">${risk.toFixed(1)}%</span>` };
                }
            }
        ];


        // --- UI HELPER FUNCTIONS ---
        function inputField(id, label, type, unit = '', placeholder = '') {
            const value = appState.values[id] || '';
            let unitSelector = '';
            if (id === 'creat' || id === 'u_creat') { unitSelector = unitDropdown('creatinine', ['mg/dL', 'µmol/L', 'mg/L']); } 
            else if (id === 'ca') { unitSelector = unitDropdown('calcium', ['mg/dL', 'mmol/L', 'mg/L']); } 
            else if (id === 'alb') { unitSelector = unitDropdown('albumin', ['g/dL', 'g/L']); }
            else if (['urea_p', 'urea_u', 'post_urea'].includes(id)) { unitSelector = unitDropdown('urea', ['mg/dL', 'mmol/L', 'g/L']); }
            else if (id === 'actual_hb' || id === 'target_hb') { unitSelector = unitDropdown('hb', ['g/dL', 'g/L', 'mmol/L']); }
             else if (id === 'glucose') { unitSelector = unitDropdown('glucose', ['mg/dL', 'mmol/L', 'g/L']); }
             else if (id === 'total_chol' || id === 'hdl_chol') { unitSelector = unitDropdown(id.split('_')[0], ['mg/dL', 'mmol/L']); }
            return `<div class="space-y-1.5"><label for="input-${id}" class="text-sm font-medium text-slate-600">${label}</label><div class="flex items-center gap-2"><input type="${type}" id="input-${id}" data-id="${id}" value="${value}" placeholder="${placeholder || '... '}" class="w-full p-2 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition">${unit ? `<span class="text-sm text-slate-500 font-semibold">${unit}</span>` : unitSelector}</div></div>`;
        }
        
        function unitDropdown(unitType, options) {
            const currentUnit = appState.units[unitType];
            const optionElements = options.map(opt => `<option value="${opt}" ${currentUnit === opt ? 'selected' : ''}>${opt}</option>`).join('');
            return `<div class="relative"><select data-unit-type="${unitType}" class="unit-select w-full p-2 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-semibold text-slate-700">${optionElements}</select></div>`;
        }
        
        function genderDropdown() {
             const currentGender = appState.values.gender || 'male';
             const options = [{value: 'male', label: 'Homme'}, {value: 'female', label: 'Femme'}];
             const optionElements = options.map(opt => `<option value="${opt.value}" ${currentGender === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('');
             return `<div class="space-y-1.5"><label for="input-gender" class="text-sm font-medium text-slate-600">Sexe</label><div class="relative"><select id="input-gender" data-id="gender" class="unit-select w-full p-2 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-semibold text-slate-700">${optionElements}</select></div></div>`;
        }
        
        function resultDisplay(resultIds) {
            const resultsHTML = resultIds.map(id => `<div id="result-${id}" class="text-slate-700 min-h-[2.5rem] leading-tight flex items-center justify-center text-center"></div>`).join('</div><div class="border-t border-emerald-100 my-1 first:border-0 first:my-0"></div><div class="text-slate-700 min-h-[1.5rem] leading-tight flex items-center justify-center text-center"');
            return `<div class="mt-4 p-3 bg-emerald-50/60 rounded-lg space-y-2 text-center">${resultsHTML}</div>`;
        }
        
        function actionButtons(calcId) {
            return `<div class="flex justify-center items-center gap-4 mt-4">
                        <button class="calculate-btn bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-8 rounded-lg shadow transition-transform transform hover:scale-105" data-calc-id="${calcId}">Calculer</button>
                        <button class="info-btn-result bg-blue-500 hover:bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center shadow transition-transform transform hover:scale-110" data-calc-id="${calcId}"><span class="font-bold italic text-red-100 text-lg">i</span></button>
                    </div>`;
        }

        function convertUnit(substance, value, fromUnit, toUnit) {
            if (fromUnit === toUnit || !value) return parseFloat(value);
            
            const CONVERSIONS = {
                urea: { base: 'mmol/L', to_base: { 'mg/dL': v => v / 6.006, 'g/L': v => v / 0.06006 }},
                creatinine: { base: 'µmol/L', to_base: { 'mg/dL': v => v * 88.4, 'mg/L': v => (v / 10) * 88.4 }},
                calcium: { base: 'mmol/L', to_base: { 'mg/dL': v => v / 4.01, 'mg/L': v => v / 40.1 }},
                albumin: { base: 'g/L', to_base: { 'g/dL': v => v * 10 }},
                hb: { base: 'g/dL', to_base: { 'g/L': v => v / 10, 'mmol/L': v => v * 1.611 }},
                glucose: { base: 'mmol/L', to_base: { 'mg/dL': v => v / 18.0182, 'g/L': v => v / 0.180182 }},
                pth: { base: 'pg/mL', to_base: { 'pmol/L': v => v / 0.106 }}
            };

            const s = CONVERSIONS[substance];
            if (!s) return parseFloat(value);

            const numericValue = parseFloat(value);
            if (isNaN(numericValue)) return NaN;

            let baseValue = numericValue;
            if (fromUnit !== s.base) {
                if (s.to_base[fromUnit]) {
                    baseValue = s.to_base[fromUnit](baseValue);
                }
            }
            
            if (toUnit === s.base) return baseValue;

            for (const key in s.to_base) {
                if (key === toUnit) {
                    const factor = s.to_base[key](1);
                    return baseValue / factor;
                }
            }
            
            return numericValue;
        }

        // --- CORE LOGIC & EVENT HANDLERS ---
        function updateAllCalculators(shouldSave = false) { document.querySelectorAll('.calculator-card').forEach(card => { if (card.offsetParent !== null) { updateSingleCalculator(card, shouldSave); } }); }
        function updateSingleCalculator(card, shouldSave) {
            const calcId = card.id.replace('calc-', '').replace('fav-','');
            const calcDef = calculators.find(c => c.id === calcId);
            if (calcDef && typeof calcDef.calculate === 'function') {
                const results = calcDef.calculate.call(card);
                Object.keys(results).forEach(resId => { const resultEl = card.querySelector(`#result-${resId}`); if (resultEl) resultEl.innerHTML = results[resId]; });
                if (shouldSave) saveLastCalculation(card);
                if (calcDef.postRender) calcDef.postRender(card);
            }
        }
        function syncAllInputs() {
             Object.keys(appState.values).forEach(id => { document.querySelectorAll(`#input-${id}`).forEach(input => { if (input.value != appState.values[id]) { input.value = appState.values[id] || ''; }}); });
            document.querySelectorAll('input[name="donor_type"], input[name="retransplant"]').forEach(radio => {
                const stateValue = appState.values[radio.name] || 'no';
                radio.checked = stateValue === radio.value;
             });
             Object.keys(appState.units).forEach(unitType => { document.querySelectorAll(`select[data-unit-type="${unitType}"]`).forEach(select => { if (select.value !== appState.units[unitType]) { select.value = appState.units[unitType]; }}); });
        }
        function handleStateChange(e) {
            const target = e.target; let needsUpdate = false;
            if (target.dataset.id) { appState.values[target.dataset.id] = target.value; needsUpdate = true; }
            if (target.dataset.unitType) { appState.units[target.dataset.unitType] = target.value; needsUpdate = true; }
            if (target.closest('#converter-body')) { handleConverterChange(target); }
            if (needsUpdate) { syncAllInputs(); }
        }
        function saveLastCalculation(card) { 
            if (!card) return;
            const calcId = card.id.replace('calc-', '').replace('fav-',''); const calcDef = calculators.find(c => c.id === calcId); if (!calcDef) return;
            const results = calcDef.calculate.call(card);
            const resultText = Object.values(results).map(r => (r || '').toString().replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim()).filter(Boolean).join(' | ');
            if (resultText && !resultText.toLowerCase().includes('n/a')) {
                const historyEntry = { id: calcId, title: calcDef.title, timestamp: new Date().toISOString(), inputs: { ...appState.values }, units: { ...appState.units }, result: resultText };
                appState.history.unshift(historyEntry);
                appState.history = [...new Map(appState.history.map(item => [item.title + item.result, item])).values()].slice(0, 20);
                localStorage.setItem('nephro_history_v39', JSON.stringify(appState.history));
                renderHistory();
            }
        }
        function renderCalculators() {
            const panes = { clinique: document.getElementById('clinique-pane'), dialyse: document.getElementById('dialyse-pane'), transplantation: document.getElementById('transplantation-pane'), ia: document.getElementById('ia-pane') };
            Object.values(panes).forEach(p => { if (p) p.innerHTML = '' }); 
            const appendCard = (calc, container) => {
                const card = document.createElement('div'); card.id = `calc-${calc.id}`; card.className = 'calculator-card bg-white p-4 rounded-xl shadow-md';
                card.dataset.tags = calc.tags; card.dataset.title = calc.title;
                card.innerHTML = `<div class="flex justify-between items-start mb-4"><h2 class="font-bold text-lg text-slate-700">${calc.title}</h2></div><div>${calc.html()}</div>`;
                container.appendChild(card);
            };
            calculators.forEach(calc => { if (panes[calc.pane]) appendCard(calc, panes[calc.pane]); });
            renderHistory(); syncAllInputs(); if(window.lucide) { lucide.createIcons(); }
        }
        function renderHistory() {
             const list = document.getElementById('history-list'); list.innerHTML = '';
             if (appState.history.length === 0) { list.innerHTML = `<div class="text-center text-slate-500 p-6 bg-white rounded-lg"><i data-lucide="list-x" class="w-10 h-10 mx-auto mb-2"></i><p>Aucun calcul dans l'historique.</p></div>`; } 
             else {
                 appState.history.forEach(entry => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-3 rounded-lg shadow-sm cursor-pointer hover:bg-slate-50 transition';
                    item.innerHTML = `<div class="flex justify-between items-center"><p class="font-semibold">${entry.title}</p><p class="text-xs text-slate-400">${new Date(entry.timestamp).toLocaleString('fr-FR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}</p></div><p class="text-sm text-emerald-600 mt-1">${entry.result}</p>`;
                    item.addEventListener('click', () => {
                        appState.values = { ...entry.inputs }; appState.units = { ...entry.units };
                        const calcDef = calculators.find(c => c.id === entry.id);
                        if (calcDef) { document.querySelector(`[data-tab="${calcDef.pane}"]`).click(); }
                        syncAllInputs(); updateAllCalculators(false);
                        setTimeout(() => { const cardToScroll = document.querySelector(`#${calcDef.pane}-pane #calc-${entry.id}`); if(cardToScroll) cardToScroll.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
                    });
                    list.appendChild(item);
                 });
             }
             if(window.lucide) { lucide.createIcons(); }
        }
        function handleTabSwitch(e) {
            const button = e.target.closest('.tab-button'); if (!button) return;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('tab-active'));
            button.classList.add('tab-active');
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            document.getElementById(`${button.dataset.tab}-pane`).classList.remove('hidden');
            updateAllCalculators(false);
        }
        function handleSearch(e) {
            const query = e.target.value.toLowerCase().trim();
            document.querySelectorAll('.calculator-card').forEach(card => {
                const tags = (card.dataset.tags || '').toLowerCase(); const title = (card.dataset.title || '').toLowerCase();
                card.style.display = (tags.includes(query) || title.includes(query)) ? 'block' : 'none';
            });
        }
        function handleCardActions(e) {
            const infoBtn = e.target.closest('.info-btn-result');
            const calcBtn = e.target.closest('.calculate-btn');
            
            if (calcBtn) {
                const card = calcBtn.closest('.calculator-card');
                updateSingleCalculator(card, true);
            }
            if (infoBtn) { 
                const calcId = infoBtn.dataset.calcId; const calc = calculators.find(c => c.id === calcId);
                document.getElementById('modal-title').innerText = `Formules: ${calc.title}`; document.getElementById('modal-content').innerHTML = calc.formula; openModal();
            }
             if (e.target.closest('#add-kdigo-creat-entry')) {
                const container = e.target.closest('.calculator-card').querySelector('#kdigo-creat-entries');
                const newEntry = document.createElement('div');
                newEntry.className = 'flex gap-2 items-center kdigo-entry';
                newEntry.innerHTML = `<input type="datetime-local" class="kdigo-creat-date border p-2 rounded-lg flex-1 bg-slate-50" value="${new Date().toISOString().slice(0, 16)}"><input type="number" step="0.01" class="kdigo-creat-value border p-2 rounded-lg flex-1 bg-slate-50" placeholder="Valeur"><button class="kdigo-creat-remove text-red-500 hover:text-red-700 p-2"><i data-lucide="x" class="w-5 h-5"></i></button>`;
                container.appendChild(newEntry); if(window.lucide) { lucide.createIcons(); }
            }
            if (e.target.closest('.kdigo-creat-remove')) {
                e.target.closest('.kdigo-entry').remove();
            }
        }
        function handleClearHistory() { appState.history = []; localStorage.removeItem('nephro_history_v39'); renderHistory(); }
        const modal = document.getElementById('formula-modal'); const modalInner = document.getElementById('modal-inner');
        function openModal() { modal.style.display = 'flex'; setTimeout(() => { modalInner.classList.remove('scale-95', 'opacity-0'); modalInner.classList.add('scale-100', 'opacity-100'); }, 10); }
        function closeModal() { modalInner.classList.add('scale-95', 'opacity-0'); setTimeout(() => { modal.style.display = 'none'; }, 200); }
        function handleConverterChange(target) {
            const key = target.dataset.converterInput || target.dataset.converterSelect;
            const sourceIdx = target.dataset.converterIdx;
            const targetIdx = sourceIdx === '1' ? '2' : '1';
            
            const card = target.closest('.calculator-card');
            const sourceInput = card.querySelector(`[data-converter-input="${key}"][data-converter-idx="${sourceIdx}"]`);
            const sourceSelect = card.querySelector(`[data-converter-select="${key}"][data-converter-idx="${sourceIdx}"]`);
            const targetInput = card.querySelector(`[data-converter-input="${key}"][data-converter-idx="${targetIdx}"]`);
            const targetSelect = card.querySelector(`[data-converter-select="${key}"][data-converter-idx="${targetIdx}"]`);

            const value = parseFloat(sourceInput.value);
            const fromUnit = sourceSelect.value;
            const toUnit = targetSelect.value;
            
            if (isNaN(value)) {
                targetInput.value = '';
                return;
            }

            const convertedValue = convertUnit(key, value, fromUnit, toUnit);
            if (targetInput !== document.activeElement) {
               targetInput.value = convertedValue.toFixed(2);
            }
        }
        function renderCreatinineGraph(card) {
            if (!card) return;
            const container = card.querySelector('#creat-entries');
            container.innerHTML = '';
            appState.creatinineHistory.forEach((entry, index) => {
                 const row = document.createElement('div');
                 row.className = 'flex gap-2 items-center';
                 row.innerHTML = `
                    <input type="date" class="creat-date border p-2 rounded-lg flex-1 bg-slate-50" value="${entry.date}" data-index="${index}">
                    <input type="number" step="0.01" class="creat-value border p-2 rounded-lg flex-1 bg-slate-50" value="${entry.value}" placeholder="Valeur" data-index="${index}">
                    <button class="creat-remove text-red-500 hover:text-red-700 p-2" data-index="${index}"><i data-lucide="x" class="w-5 h-5"></i></button>
                 `;
                 container.appendChild(row);
            });

            const ctx = card.querySelector('#creatinine-chart-canvas').getContext('2d');
            if (creatinineChart) creatinineChart.destroy();
            const sortedEntries = [...appState.creatinineHistory].filter(e => e.date && e.value).sort((a,b) => new Date(a.date) - new Date(b.date));
            creatinineChart = new Chart(ctx, { type: 'line', data: { labels: sortedEntries.map(e => new Date(e.date).toLocaleDateString('fr-FR')), datasets: [{ label: `Créatininémie (${appState.units.creatinine})`, data: sortedEntries.map(e => e.value), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.1, fill: true }] }, options: { responsive: true, maintainAspectRatio: true } });
            if(window.lucide) { lucide.createIcons(); }
        }
         function renderKdigoCreatinineEntries(card) {
            const container = card.querySelector('#kdigo-creat-entries');
            if(container.children.length === 0){
                for(let i=0; i<2; i++){
                    const newEntry = document.createElement('div');
                    newEntry.className = 'flex gap-2 items-center kdigo-entry';
                    newEntry.innerHTML = `<input type="datetime-local" class="kdigo-creat-date border p-2 rounded-lg flex-1 bg-slate-50" value="${new Date().toISOString().slice(0, 16)}"><input type="number" step="0.01" class="kdigo-creat-value border p-2 rounded-lg flex-1 bg-slate-50" placeholder="${i === 0 ? 'Créat de base (si connue)' : 'Créat actuelle'}"><button class="kdigo-creat-remove text-red-500 hover:text-red-700 p-2"><i data-lucide="x" class="w-5 h-5"></i></button>`;
                    container.appendChild(newEntry);
                }
                if(window.lucide) lucide.createIcons();
            }
        }
        function evaluateKdigo(card){
            let diagnosis = [];
            let color = 'text-green-600';

            // Diuresis criteria
            const { urine_vol_kdigo, urine_hours_kdigo, weight } = appState.values;
            if(urine_vol_kdigo && urine_hours_kdigo && weight){
                const diuresis_ml_kg_h = urine_vol_kdigo / weight / urine_hours_kdigo;
                if(diuresis_ml_kg_h < 0.5 && urine_hours_kdigo >= 6){
                    diagnosis.push("IRA Stade 1 (Critère Diurèse)");
                    color = 'text-orange-600';
                }
            }

            // Creatinine criteria
            const entries = Array.from(card.querySelectorAll('.kdigo-entry')).map(row => ({
                date: new Date(row.querySelector('.kdigo-creat-date').value),
                value: parseFloat(row.querySelector('.kdigo-creat-value').value)
            })).filter(e => e.date && !isNaN(e.value)).sort((a,b) => a.date - b.date);

            if(entries.length >= 2){
                for(let i = 0; i < entries.length; i++){
                    for(let j = i + 1; j < entries.length; j++){
                        const time_diff_hours = (entries[j].date - entries[i].date) / (1000 * 60 * 60);
                        const creat_i_mgdl = convertUnit('creatinine', entries[i].value, appState.units.creatinine, 'mg/dL');
                        const creat_j_mgdl = convertUnit('creatinine', entries[j].value, appState.units.creatinine, 'mg/dL');
                        const creat_diff = creat_j_mgdl - creat_i_mgdl;

                        if(creat_diff >= 0.3 && time_diff_hours <= 48){
                             if(!diagnosis.includes("IRA Stade 1 (Critère Créatinine)")) diagnosis.push("IRA Stade 1 (Critère Créatinine)");
                             color = 'text-orange-600';
                        }
                    }
                    if(i > 0 && entries[i].value >= 1.5 * entries[0].value){
                        if(!diagnosis.includes("IRA Stade 1 (Critère Créatinine)")) diagnosis.push("IRA Stade 1 (Critère Créatinine)");
                        color = 'text-orange-600';
                    }
                }
            }
            
            let finalDiagnosis = "Critères d'IRA non remplis.";
            if(diagnosis.length > 0){
                finalDiagnosis = diagnosis.join(' et ');
            }
            
            card.querySelector('#result-kdigo_result').innerHTML = `<span class="font-bold text-lg ${color}">${finalDiagnosis}</span>`;
        }
        function init() {
            const contentPanes = document.getElementById('content-panes');
            document.getElementById('main-tabs').addEventListener('click', handleTabSwitch);
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            contentPanes.addEventListener('input', handleStateChange); 
            contentPanes.addEventListener('change', (e) => { if(e.target.dataset.converterSelect) handleConverterChange(e.target); });
            contentPanes.addEventListener('click', handleCardActions);
            document.getElementById('clearHistoryBtn').addEventListener('click', handleClearHistory);
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            renderCalculators();
        }
        init();
    });
    </script>
</body>
</html>
